---
title: 关于数据库优化的几个深入思考
date: 2017-05-11 20:27:17
tags: 数据库
photos:
- http://odbihfqll.bkt.clouddn.com/image/movie/haer.jpg

---

数据库优化可以给数据库的操作带来很大提升，但是这种优化是基于一定背景的，也是有一定目的的，不能够说有这种优化就直接去做了。

首先第一个谈论最多的就是**分库分表**，它的字面意思就是说将原本在一个数据库的数据分到多个数据库，将原本的一张表分成多张表，为什么要这么做呢？数据库的数据量大部分时候是不可控的，随着表中的数据量越来越大，如果不分表的话，增删改查的开销也会越来越大，如果不分库的话，一台服务器的资源（cpu，磁盘，内存，io）是有限的，最终数据库的处理能力会到达瓶颈。

<!-- more -->

这里可能有一个问题，为什么表大的话 *curd* 的效率会低呢？首先如果没有建立索引的话，查询是一条条记录查询的，这样数据量大的话自然查询慢，另外即使建索引，在数据量大的情况下，索引表也是很大的（索引工作原理？）。

分表又分为**水平分表**和**垂直分表**

垂直分表的话，就是按照功能模块，使用频率，关系亲密程度划分到不同的表中，将主键和一些列放到一个表中，将主键和另一些放到另一个表中，这样一个表就被划分成了多个只包含较少列的表

**优点**： 

* 垂直分割可以使得行数据变小，一个数据块(Block)就能存放更多的数据，	        在查询时就会减少I/O次数(每次查询时读取的Block 就少)
* 垂直分割表可以达到最大化利用Cache的目的。 

**缺点**： 

* 表垂直分割后，主码(主键)出现冗余，需要管理冗余列 
* 会引起表连接JOIN操作（增加CPU开销）需要从业务上规避

比如对于用户表，我将用户表划分为用户详情表和用户账户表，因为用户登入的操作比较多，所以就单独设置了一个表。便于维护。然后将新闻消息表分为新闻索引表和新闻详情表，在第一个表里我放的是消息 id，创建时间，作者，点赞数，差评数，已阅读人数。然后第二张表放的是新闻 id，图片链接，内容，作者。这样超级管理员不关心内容，直接操作第一张表就可以知道消息发送者发送消息的情况。

水平分表的话，一般是用在数据量过大的情况，按照某种规则进行水平的划分，比如将 userid求散列取模存储到不同的表中。

这样优化其实也会带来很多操作上的问题。

一个是事务问题，分到不同数据库后，跨库事务管理将变得十分困难？（很少使用，一般也不支持跨库事务，可能在一个新老系统在不同的数据库中，可以旧库放一个**临时表**，在临时表中存放需要同步的数据，再将数据同步到新库中，同步完就将临时表里的数据删除）

跨库跨表的 join 问题，我们无法 join 不同分库的表，需要进行多次查询

额外的运算，比如要查询点赞数前10的文章，要先查出每个分表的前10，然后对这些数据合并进行运算，当然如果可以向 mapreduce 那样实现分布式运算是再好不过的

再其次使用频率最多的就是建立**索引**了。那么建索引为什么可以优化查询呢？索引的原理又是什么？什么情况下用索引？

我们知道一般的应用系统，读写比例在10:1左右，而且插入操作和一般的更新操作很少出现性能问题，遇到最多的，也是最容易出问题的，还是一些复杂的查询操作，所以查询语句的优化显然是重中之重。

索引的原理就如同通过字典查单词一样不断缩小查询范围，因为数据是存放在磁盘中的，每次都要将数据从磁盘中的数据取到内存中操作，这种 IO 操作是十分耗时间的，所以要**控制 IO 次数**，于是就采用了**B+树 **，叶子节点存储真正的数据项而非叶子节点只是存储用来判断搜索方向的数据项，所以在查找的时候 IO 次数**取决于 B+树的高度**。而这个高度又取决于节点也就是一个数据块所能存储的数据项的大小，数据块的大小是固定的，所以数据项应该尽可能小。所以要给索引字段选择合适的大小。这也是为什么要用叶子节点取存储数据项（因为可以选择合适的大小，而不会导致节点里的数据项过少）。

也可以使用 hash 去实现索引，但是这样的话在范围查找时就无用武之地了。

使用索引的原则：

1. **最左匹配原则**，当有复合索引时，会先从第一个开始匹配。
2. 尽量选择**区分度高**的作为索引，这样扫描的记录数就会越少。
3. 尽量扩展索引而不是新建索引，也就是建立联合索引。

当查询涉及多个字段时应该设置复合索引而不是每一个字段一个单列索引，因为 Mysql 它**只会选择使用限制条件最严格的索引**，其它的索引就不会使用了。